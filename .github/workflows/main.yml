name: Build and Deploy
on:
  push:
    branches:
      - source
  schedule:
  - cron: "0 2 * * *"
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code ğŸ›ï¸
      uses: actions/checkout@v4
    - name: Setup Ruby !
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: "3.3.5"
        bundler-cache: true
    - name: Setup Python ğŸ
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        cache: "pip" # caching pip dependencies
    - name: Install and Build ğŸ”§
      run: |
          sudo apt-get update && sudo apt-get install -y imagemagick
          pip3 install --upgrade nbconvert requests
          export JEKYLL_ENV=production
          bundle exec jekyll build
    - name: Purge unused CSS ğŸ§¹
      run: |
          npm install -g purgecss
          purgecss -c purgecss.config.js
    - name: Setup deploy options ğŸ”§
      id: setup
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        if [[ ${GITHUB_REF} = refs/pull/*/merge ]]; then # pull request
          echo "::set-output name=SRC_BRANCH::${GITHUB_HEAD_REF}"
          echo "::set-output name=NO_PUSH::--no-push"
        elif [[ ${GITHUB_REF} = refs/heads/* ]]; then # branch, e.g. master, source etc
          echo "::set-output name=SRC_BRANCH::${GITHUB_REF#refs/heads/}"
        fi
        if [[ ${{ github.repository }} = *.github.io ]]; then # user/org repo
          echo "::set-output name=DEPLOY_BRANCH::master"
        else
          echo "::set-output name=DEPLOY_BRANCH::gh-pages"
        fi
    - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: _site
    # - name: Deploy website ğŸš€
    #   run:  bin/update --src ${{ steps.setup.outputs.SRC_BRANCH }} 
    #                 --deploy ${{ steps.setup.outputs.DEPLOY_BRANCH }}
